CREATE DATABASE oi;
USE oi;
CREATE TABLE CLIENTES
(
    COD_CLIENTE INT         NOT NULL,
    NOMBRE      VARCHAR(50) NOT NULL,
    APELLIDO    VARCHAR(50) NOT NULL,
    DIRECCION   VARCHAR(50) NOT NULL,
    FECHA_NAC   DATE        NOT NULL,
    EDAD        INT,
    SEXO        VARCHAR(50),
    CIUDAD      VARCHAR(50),
    PROVINCIA   VARCHAR(50),
    PAIS        VARCHAR(50),
    PRIMARY KEY (COD_CLIENTE)
);

CREATE TABLE DOCUMENTOS
(
    COD_DOCUMENTO INT         NOT NULL,
    COD_CLIENTE   INT         NOT NULL,
    TIPO          VARCHAR(50) NOT NULL,
    NUMERO        INT         NOT NULL,
    PRIMARY KEY (COD_DOCUMENTO),
    CONSTRAINT FK_COD_CLIENTE FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTES (COD_CLIENTE)
);



CREATE TABLE FACTURA_CABECERA
(
    COD_CABECERA      INT NOT NULL,
    COD_CLIENTE       INT NOT NULL,
    FECHA_VENTA       DATE,
    COMENTARIOS_VENTA VARCHAR(150),
    PRIMARY KEY (COD_CABECERA),
    CONSTRAINT fk_CODIGO_CLIENTE FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTES (COD_CLIENTE)
);


create table CATEGORIAS
(
    COD_CATEGORIA INT NOT NULL,
    CATEGORIA     VARCHAR(50),
    PRIMARY KEY (COD_CATEGORIA)
);

create table PROVEEDORES
(
    COD_PROVEEDOR int         not null,
    NOMBRE        VARCHAR(50) NOT NULL,
    DIRECCION     VARCHAR(50),
    CIUDAD        VARCHAR(50),
    PRIMARY KEY (COD_PROVEEDOR)
);


create table PRODUCTOS
(
    COD_PRODUCTO      INT         NOT NULL,
    COD_CATEGORIA     INT         NOT NULL,
    COD_PROVEEDOR     INT         NOT NULL,
    PRODUCTO          VARCHAR(50) NOT NULL,
    MARCA             VARCHAR(50) NOT NULL,
    PU                INT         NOT NULL,
    FECHA_VENCIMIENTO DATE,
    PRIMARY KEY (COD_PRODUCTO),
    CONSTRAINT fk_COD_CATEGORIA FOREIGN KEY (COD_CATEGORIA) REFERENCES CATEGORIAS (COD_CATEGORIA),
    CONSTRAINT fk_COD_PROVEEDOR FOREIGN KEY (COD_PROVEEDOR) REFERENCES PROVEEDORES (COD_PROVEEDOR)
);

CREATE TABLE FACTURA_DETALLE
(
    COD_DETALLE  INT NOT NULL,
    COD_CABECERA INT NOT NULL,
    COD_PRODUCTO INT NOT NULL,
    CANTIDAD     INT NOT NULL,
    PRIMARY KEY (COD_DETALLE),
    CONSTRAINT fk_COD_CABECERA FOREIGN KEY (COD_CABECERA) REFERENCES FACTURA_CABECERA (COD_CABECERA),
    CONSTRAINT fk_COD_PRODUCTO FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTOS (COD_PRODUCTO)
);


INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (1, 'LACTEOS');
INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (2, 'CARNES');
INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (3, 'EMBUTIDOS');
INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (4, 'FRUTAS');
INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (5, 'VERDURAS');
INSERT INTO CATEGORIAS (COD_CATEGORIA, CATEGORIA)
VALUES (6, 'BEBIDAS ALCOHOLICAS');

INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (1, 'LA SERENISIMA', 'MADRIAGA 523', 'BUENOS AIRES');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (2, 'SANCOR', 'MADRID 53', 'BUENOS AIRES');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (3, 'LA MARTINA', 'ONTIVEROS 4213', 'BUENOS AIRES');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (4, 'LA ROMANA', 'SAN JUSTO 2331', 'CORDOBA');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (5, 'COTO', 'GRANADA 90', 'BUENOS AIRES');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (6, 'UVITA', 'CRAVERO 202', 'MENDOZA');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (7, 'MICHEL TORINO', 'ILLIA 528', 'MENDOZA');
INSERT INTO PROVEEDORES (COD_PROVEEDOR, NOMBRE, DIRECCION, CIUDAD)
VALUES (8, 'CARREFOUR', 'BALENCIAGA 2895', 'BUENOS AIRES');

INSERT INTO PRODUCTOS(COD_PRODUCTO, COD_CATEGORIA, COD_PROVEEDOR, PRODUCTO, MARCA, PU, FECHA_VENCIMIENTO)
VALUES (1, 1, 1, 'Leche', 'La Sere', 150, '2018-05-05');

INSERT INTO PRODUCTOS(COD_PRODUCTO, COD_CATEGORIA, COD_PROVEEDOR, PRODUCTO, MARCA, PU, FECHA_VENCIMIENTO)
VALUES (2, 1, 2, 'Queso', 'La Sere', 150, '2020-05-05');

INSERT INTO PRODUCTOS(COD_PRODUCTO, COD_CATEGORIA, COD_PROVEEDOR, PRODUCTO, MARCA, PU, FECHA_VENCIMIENTO)
VALUES (3, 1, 1, 'Queso Crema', 'La Lechona', 150, '2019-01-01');

INSERT INTO PRODUCTOS(COD_PRODUCTO, COD_CATEGORIA, COD_PROVEEDOR, PRODUCTO, MARCA, PU, FECHA_VENCIMIENTO)
VALUES (4, 1, 1, 'Leche', 'La Lechona', 150, '2019-01-01');

INSERT INTO CLIENTES(COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC)
VALUES (1, 'PEPE', 'EL', 'ALGUNA 123', '1970-01-12');

INSERT INTO CLIENTES (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD, SEXO, CIUDAD, PROVINCIA, PAIS)
VALUES (2, 'CARLOS', 'PEREZ', 'HAGHI 28', '2005-02-24', 15, 'MASCULINO', 'MORON', 'BUENOS AIRES', 'ARGENTINA');
INSERT INTO CLIENTES (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD, SEXO, CIUDAD, PROVINCIA, PAIS)
VALUES (3, 'IVANA', 'DIAZ', 'SAN JUAN 322', '1975-07-31', 45, 'FEMENINO', 'VILLA TESEI', 'BUENOS AIRES', 'ARGENTINA');
INSERT INTO CLIENTES (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD, SEXO, CIUDAD, PROVINCIA, PAIS)
VALUES (4, 'BENITO', 'GARCIA', 'YACARA 15', '1980-05-05', 40, 'MASCULINO', 'VILLA FIORITO', 'BUENOS AIRES',
        'ARGENTINA');
INSERT INTO CLIENTES (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD, SEXO, CIUDAD, PROVINCIA, PAIS)
VALUES (5, 'MARCELA', 'GALLO', 'PERKINS 555', '1999-06-15', 21, 'FEMENINO', 'CASTELAR', 'BUENOS AIRES', 'ARGENTINA');
INSERT INTO CLIENTES (COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD, SEXO, CIUDAD, PROVINCIA, PAIS)
VALUES (6, 'LETICIA', 'FERNANDEZ', 'PINIFARINA 2020', '2000-07-17', 20, 'FEMENINO', 'TORTUGUITAS', 'BUENOS AIRES',
        'ARGENTINA');

INSERT INTO FACTURA_CABECERA(COD_CABECERA, COD_CLIENTE, FECHA_VENTA)
VALUES (1, 1, '2020-01-15');
INSERT INTO FACTURA_CABECERA(COD_CABECERA, COD_CLIENTE, FECHA_VENTA)
VALUES (2, 2, '2020-05-20');
INSERT INTO FACTURA_CABECERA(COD_CABECERA, COD_CLIENTE, FECHA_VENTA)
VALUES (3, 1, '2020-05-20');

INSERT INTO FACTURA_DETALLE(COD_DETALLE, COD_CABECERA, COD_PRODUCTO, CANTIDAD)
VALUES (1, 1, 1, 1);
INSERT INTO FACTURA_DETALLE(COD_DETALLE, COD_CABECERA, COD_PRODUCTO, CANTIDAD)
VALUES (2, 2, 4, 1);
INSERT INTO FACTURA_DETALLE(COD_DETALLE, COD_CABECERA, COD_PRODUCTO, CANTIDAD)
VALUES (3, 3, 3, 1);

# Calcular la cantidad de clientes que han comprado productos del tipo LÁCTEOS durante el 01/ENE/2018 y 20/ENE/2019.
SELECT COUNT(*)
FROM (SELECT CLIENTES.COD_CLIENTE, CLIENTES.NOMBRE, PRODUCTO
      FROM CLIENTES,
           FACTURA_CABECERA,
           FACTURA_DETALLE,
           PRODUCTOS,
           CATEGORIAS
      WHERE CLIENTES.COD_CLIENTE = FACTURA_CABECERA.COD_CLIENTE
        AND FACTURA_DETALLE.COD_CABECERA = FACTURA_CABECERA.COD_CABECERA
        AND PRODUCTOS.COD_PRODUCTO = FACTURA_DETALLE.COD_PRODUCTO
        AND CATEGORIAS.COD_CATEGORIA = PRODUCTOS.COD_CATEGORIA
        AND CATEGORIA = 'LACTEOS'
     ) as LACTEOS;

# Listar las compras realizadas (mostrar datos de Clientes y Productos) ordenado por fecha de venta y agrupado por CLIENTE.
SELECT CLIENTES.NOMBRE,
       CLIENTES.APELLIDO,
       PRODUCTOS.PRODUCTO,
       PRODUCTOS.MARCA,
       PRODUCTOS.PU,
       FACTURA_CABECERA.FECHA_VENTA
FROM FACTURA_CABECERA,
     FACTURA_DETALLE,
     CLIENTES,
     PRODUCTOS
WHERE CLIENTES.COD_CLIENTE = FACTURA_CABECERA.COD_CLIENTE
  AND PRODUCTOS.COD_PRODUCTO = FACTURA_DETALLE.COD_PRODUCTO
  AND FACTURA_CABECERA.COD_CABECERA = FACTURA_DETALLE.COD_CABECERA
GROUP BY CLIENTES.COD_CLIENTE, FECHA_VENTA
ORDER BY FECHA_VENTA;


# Calcular el promedio de edad de los clientes que compran productos de categorías Bebidas alcohólicas, donde los proveedores sean oriundos de Mendoza.

INSERT INTO CLIENTES(COD_CLIENTE, NOMBRE, APELLIDO, DIRECCION, FECHA_NAC, EDAD)
VALUES (7, 'MARCELO', 'MONSE', 'LALO CURA 2134', '1978-03-13', 42);

INSERT INTO PRODUCTOS(COD_PRODUCTO, COD_CATEGORIA, COD_PROVEEDOR, PRODUCTO, MARCA, PU, FECHA_VENCIMIENTO)
VALUES (5, 6, 1, 'APERITIVO', 'FERNET', 500, '2021-02-03')

INSERT INTO FACTURA_CABECERA(COD_CABECERA, COD_CLIENTE, FECHA_VENTA, COMENTARIOS_VENTA)
VALUES (4, 7, NOW(), '');

INSERT INTO FACTURA_DETALLE(COD_DETALLE, COD_CABECERA, COD_PRODUCTO, CANTIDAD)
VALUES (4, 4, 5, 2);

SELECT AVG(DATEDIFF(NOW(), CLIENTES.FECHA_NAC) / 365)
FROM CLIENTES,
     CATEGORIAS,
     PRODUCTOS,
     FACTURA_CABECERA,
     FACTURA_DETALLE
WHERE CLIENTES.COD_CLIENTE = FACTURA_CABECERA.COD_CLIENTE
  AND FACTURA_DETALLE.COD_CABECERA = FACTURA_CABECERA.COD_CABECERA
  AND PRODUCTOS.COD_PRODUCTO = FACTURA_DETALLE.COD_PRODUCTO
  AND CATEGORIAS.COD_CATEGORIA = PRODUCTOS.COD_CATEGORIA
  AND CATEGORIA = 'BEBIDAS ALCOHOLICAS';
